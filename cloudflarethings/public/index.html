<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DSE 搜尋趨勢分析</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2"></script>
    <link rel="stylesheet" href="/styles.css">
    <style>
        * { box-sizing: border-box; }
        html,body { height: 100%; }
        body {
            margin: 0;
            font-family: 'Microsoft JhengHei', 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg,#E0F7FA 0%,#B2DFDB 100%);
            padding: 24px;
            color: #123;
        }
        .page { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 18px; }
        .main-title { color: #00838F; font-size: 2rem; margin: 0; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
        .box { background: #fff; padding: 18px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .text-box { white-space: pre-wrap; font-size: 15px; line-height: 1.6; }
        .chart-box { height: 360px; position: relative; overflow: hidden; }
        .chart-box canvas { width: 100% !important; height: 100% !important; display: block; }
        h2 { margin: 0 0 12px 0; font-size: 1.1rem; color: #264653; border-bottom: 1px solid #eef; padding-bottom: 8px; }
        @media (max-width: 820px) { .container { grid-template-columns: 1fr; } }
        .cohort-select { margin-top:8px; }
    </style>
</head>

<body>
  <div class="page">
    <header class="header">
      <h1 class="main-title">DSE 搜尋趨勢分析</h1>
      <div id="heroTyping" class="box" style="margin-top:12px; background:transparent; box-shadow:none; padding:0; text-align:center; font-size:1.05rem; color:#044;">載入中…</div>
    </header>

    <main class="container">
      <!-- left: dialogues -->
      <section class="box" aria-labelledby="dialogues-heading">
        <h2 id="dialogues-heading">對話紀錄（從資料庫）</h2>
        <div id="dialogues-list" style="max-height:420px; overflow:auto; border-radius:8px; padding:8px; background:#fbfbfb; border:1px solid #eef;">
          <div style="color:#888; font-size:0.95rem">載入中…</div>
        </div>
      </section>

      <!-- right: main trend chart -->
      <section class="box chart-box" aria-labelledby="chart-heading">
        <h2 id="chart-heading">DSE 搜尋趨勢 (整體)</h2>
        <canvas id="trendChart" role="img" aria-label="DSE 搜尋趨勢圖"></canvas>
        <div id="chartDebug" style="margin-top:8px; font-size:0.85rem; color:#a33"></div>
        <div style="margin-top:12px">
          <button id="adminCleanupBtn" style="padding:8px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer">DB Cleanup</button>
        </div>
      </section>
    </main>

        <!-- Three specific sheet charts, full width stacked below -->
        <div style="max-width:1200px;margin:18px auto 36px; display:grid; gap:18px;">
            <section class="box chart-box" aria-labelledby="sheet1-heading">
                <h2 id="sheet1-heading">表格 1 - 累積趨勢</h2>
                <div class="cohort-select">群組: <select id="cohort1"><option value="day_total">Day Total</option><option value="day_male">Day Male</option><option value="day_female">Day Female</option><option value="all_total">All Total</option><option value="all_male">All Male</option><option value="all_female">All Female</option></select></div>
                <canvas id="chart1"></canvas>
                <div id="debug1" style="margin-top:8px;color:#a33;font-size:0.9rem"></div>
            </section>

            <section class="box chart-box" aria-labelledby="sheet2-heading">
                <h2 id="sheet2-heading">表格 2 - 累積趨勢</h2>
                <div class="cohort-select">群組: <select id="cohort2"><option value="day_total">Day Total</option><option value="day_male">Day Male</option><option value="day_female">Day Female</option><option value="all_total">All Total</option><option value="all_male">All Male</option><option value="all_female">All Female</option></select></div>
                <canvas id="chart2"></canvas>
                <div id="debug2" style="margin-top:8px;color:#a33;font-size:0.9rem"></div>
            </section>

            <section class="box chart-box" aria-labelledby="sheet3-heading">
                <h2 id="sheet3-heading">表格 3 - 累積趨勢</h2>
                <div class="cohort-select">群組: <select id="cohort3"><option value="day_total">Day Total</option><option value="day_male">Day Male</option><option value="day_female">Day Female</option><option value="all_total">All Total</option><option value="all_male">All Male</option><option value="all_female">All Female</option></select></div>
                <canvas id="chart3"></canvas>
                <div id="debug3" style="margin-top:8px;color:#a33;font-size:0.9rem"></div>
            </section>
        </div>
    </div>

    <script>
    // Page simplified: no README/markdown. Focus on charts and dialogues.

        // Safe SQL posts to /api/sql
        const ALLOWED_COHORTS = new Set(['day_total','day_male','day_female','all_total','all_male','all_female']);
        const ALLOWED_TABLES = ['sheet1','sheet2','sheet3'];

        async function postSQL(query){
            const res = await fetch('/api/sql', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ query }) });
            if(!res.ok) throw new Error('/api/sql returned ' + res.status);
            return await res.json();
        }

        async function fetchD1RowsSafe(table, cohort){
            if(!ALLOWED_TABLES.includes(table)) throw new Error('Invalid table');
            if(!ALLOWED_COHORTS.has(cohort)) cohort = 'all_total';
            const q = `SELECT label, COALESCE(${cohort},0) AS value FROM ${table} ORDER BY id ASC`;
            const j = await postSQL(q);
            const rows = Array.isArray(j.rows) ? j.rows : (Array.isArray(j.results) ? j.results : (Array.isArray(j) ? j : []));
            return rows;
        }

        async function fetchDialogues(){
            const target = document.getElementById('dialogues-list');
            try{
                const res = await fetch('/api/dialogue');
                if(!res.ok) throw new Error('dialogue fetch ' + res.status);
                const j = await res.json();
                const rows = Array.isArray(j.rows) ? j.rows : (Array.isArray(j) ? j : []);
                if(!rows || rows.length===0){ target.innerHTML = '<div style="color:#666">沒有對話紀錄。</div>'; return; }
                const ordered = rows.slice().reverse();
                target.innerHTML = '';
                for(const r of ordered){
                    const el = document.createElement('div');
                    el.style.padding = '8px 6px'; el.style.borderBottom = '1px solid #f0f0f0';
                    el.innerHTML = `<div style="font-size:0.95rem;color:#123"><strong>${escapeHtml(r.role||'')}</strong> <span style="color:#888;font-size:0.85rem">${r.created_at||''}</span></div><div style="margin-top:6px;color:#333;white-space:pre-wrap">${escapeHtml(r.message||'')}</div>`;
                    target.appendChild(el);
                }
            }catch(err){ console.warn('fetchDialogues error',err); target.innerHTML = '<div style="color:#a33">無法載入對話（請檢查 /api/dialogue）</div>'; }
        }

        function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        function toChartData(rows){ return { labels: rows.map(r=>r.label), data: rows.map(r=>Number(r.value)||0) }; }

        // main big chart (trendChart) - reuse same /api/sql but query dse_trends if present
        async function initMainTrend(){
            try{
                const res = await fetch('/api/sql', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ query: 'SELECT date, value FROM dse_trends ORDER BY date ASC' }) });
                if(!res.ok) throw new Error('api/sql returned ' + res.status);
                const j = await res.json();
                const rows = Array.isArray(j.rows) ? j.rows : (Array.isArray(j.results) ? j.results : (Array.isArray(j)? j: []));
                if(!rows || rows.length===0) { document.getElementById('chartDebug').textContent = '沒有主趨勢資料'; return; }
                document.getElementById('chartDebug').textContent = '';
                const cdata = toChartData(rows.map(r=>({ label: r.date, value: r.value })));
                const ctx = document.getElementById('trendChart').getContext('2d');
                if(window._trendChartInstance) window._trendChartInstance.destroy();
                window._trendChartInstance = new Chart(ctx, {
                    type:'line',
                    data: { labels: cdata.labels, datasets: [{ label:'DSE 搜尋趨勢', data: cdata.data, borderColor:'rgba(38,166,154,0.9)', backgroundColor:'rgba(38,166,154,0.12)'}] },
                    options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ x: { type:'time', time:{ unit:'month' } }, y:{ beginAtZero:true } } }
                });
            }catch(err){ document.getElementById('chartDebug').textContent = '無法取得主趨勢資料'; console.warn(err); }
        }

        // sheet charts: load, cumulate and render
        window._sheetCharts = window._sheetCharts || {};
        async function loadSheetChart(n){
            const debug = document.getElementById('debug'+n);
            const sel = document.getElementById('cohort'+n);
            const canvas = document.getElementById('chart'+n);
            if(!sel || !canvas || !debug) return;
            debug.textContent = '載入中⋯';
            const cohort = ALLOWED_COHORTS.has(sel.value) ? sel.value : 'all_total';
            const table = ALLOWED_TABLES[n-1];
            try{
                const rows = await fetchD1RowsSafe(table, cohort);
                if(!rows || rows.length===0){ debug.textContent = '沒有資料'; if(window._sheetCharts[n]){ window._sheetCharts[n].destroy(); delete window._sheetCharts[n]; } return; }
                const labels = rows.map(r=>r.label);
                const vals = rows.map(r=>Number(r.value)||0);
                const cum = []; let s=0; for(const v of vals){ s+=v; cum.push(s); }
                const ctx = canvas.getContext('2d'); if(window._sheetCharts[n]) window._sheetCharts[n].destroy();
                window._sheetCharts[n] = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label:`累積 (${cohort})`, data:cum, borderColor:'#1976d2', backgroundColor:'#1976d222', fill:true, tension:0.2 }] }, options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ x:{ display:true }, y:{ beginAtZero:true } } } });
                debug.textContent = '';
            }catch(err){ debug.textContent = '錯誤: ' + (err.message||String(err)); console.warn(err); }
        }

        // typing effect
        function typingEffect(containerSelector, text){
            const container = document.querySelector(containerSelector); if(!container) return; container.textContent='';
            const cursor = document.createElement('span'); cursor.className='typing-cursor'; cursor.textContent='|'; container.appendChild(cursor);
            const chars = Array.from(text); let i=0; function next(){ if(i>=chars.length){ cursor.classList.add('blink'); return; } container.insertBefore(document.createTextNode(chars[i]), cursor); i++; setTimeout(next, 40 + Math.random()*50); } next();
        }

        // admin cleanup
        (function(){ const btn = document.getElementById('adminCleanupBtn'); if(!btn) return; btn.addEventListener('click', async ()=>{ btn.disabled=true; btn.textContent='Cleaning...'; try{ const r = await fetch('/api/admin/cleanup',{ method:'POST' }); const j = await r.json(); document.getElementById('chartDebug').textContent = 'Cleanup: ' + JSON.stringify(j); await initMainTrend(); await fetchDialogues(); }catch(e){ document.getElementById('chartDebug').textContent='Cleanup error'; console.warn(e); } finally{ btn.disabled=false; btn.textContent='DB Cleanup'; } }); })();

    document.addEventListener('DOMContentLoaded', ()=>{
      initMainTrend();
      fetchDialogues();
      typingEffect('#heroTyping', '歡迎來到 DSE 趨勢分析平台');
      // wire sheet charts
      for(let n=1;n<=3;n++){ const sel = document.getElementById('cohort'+n); if(sel){ sel.addEventListener('change', ()=>loadSheetChart(n)); } loadSheetChart(n); }
    });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DSE 趨勢分析</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; background: #e0f7fa; margin: 0; padding: 2em; }
    .container { max-width: 700px; margin: 0 auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px #0001; padding: 2em; }
    h1 { color: #00838F; }
    #trendChart { width: 100%; height: 320px; }
    #chartDebug { color: #a33; font-size: 0.95em; margin: 1em 0; }
    #dialogues-list { background: #f8f8f8; border-radius: 6px; padding: 1em; margin-top: 1em; min-height: 2em; }
    .dialogue { border-bottom: 1px solid #eee; padding: 0.5em 0; }
    .dialogue:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>DSE 趨勢分析</h1>

    <!-- Chart 1 -->
    <section>
      <h2>表格 1</h2>
      <label>群組: <select id="cohort1"><option value="day_total">Day Total</option><option value="day_male">Day Male</option><option value="day_female">Day Female</option><option value="all_total">All Total</option><option value="all_male">All Male</option><option value="all_female">All Female</option></select></label>
      <canvas id="chart1" style="height:220px"></canvas>
      <div id="debug1" class="debug"></div>
    </section>

    <!-- Chart 2 -->
    <section>
      <h2>表格 2</h2>
      <label>群組: <select id="cohort2"><option value="day_total">Day Total</option><option value="day_male">Day Male</option><option value="day_female">Day Female</option><option value="all_total">All Total</option><option value="all_male">All Male</option><option value="all_female">All Female</option></select></label>
      <canvas id="chart2" style="height:220px"></canvas>
      <div id="debug2" class="debug"></div>
    </section>

    <!-- Chart 3 -->
    <section>
      <h2>表格 3</h2>
      <label>群組: <select id="cohort3"><option value="day_total">Day Total</option><option value="day_male">Day Male</option><option value="day_female">Day Female</option><option value="all_total">All Total</option><option value="all_male">All Male</option><option value="all_female">All Female</option></select></label>
      <canvas id="chart3" style="height:220px"></canvas>
      <div id="debug3" class="debug"></div>
    </section>

    <h2>對話紀錄</h2>
    <div id="dialogues-list">載入中…</div>
  </div>
  <script>
  (function(){
    const ALLOWED_COHORTS = new Set(['day_total','day_male','day_female','all_total','all_male','all_female']);
    const ALLOWED_TABLES = ['sheet1','sheet2','sheet3'];
    window._chartInstances = window._chartInstances || {};

    async function postSQL(query){
      const res = await fetch('/api/sql', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });
      if(!res.ok) throw new Error('/api/sql returned ' + res.status);
      const j = await res.json();
      return Array.isArray(j.rows) ? j.rows : [];
    }

    function validateCohort(c){ return ALLOWED_COHORTS.has(c) ? c : 'all_total'; }

    async function loadSheetChart(n){
      const cohortEl = document.getElementById('cohort'+n);
      const debugEl = document.getElementById('debug'+n);
      const canvas = document.getElementById('chart'+n);
      if(!cohortEl || !debugEl || !canvas) { console.warn('Missing chart elements', n); return; }
      const cohort = validateCohort(cohortEl.value);
      const table = ALLOWED_TABLES[n-1];
      debugEl.textContent = '載入中⋯';
      const query = `SELECT label, COALESCE(${cohort},0) AS value FROM ${table} ORDER BY id ASC`;
      try {
        const rows = await postSQL(query);
        if(!rows.length){
          debugEl.textContent = '沒有資料';
          if(window._chartInstances[n]){ window._chartInstances[n].destroy(); delete window._chartInstances[n]; }
          return;
        }
        const labels = rows.map(r=>r.label);
        const vals = rows.map(r=>Number(r.value)||0);
        const cum = [];
        let s = 0;
        for(const v of vals){ s += v; cum.push(s); }

        const ctx = canvas.getContext('2d');
        if(window._chartInstances[n]) window._chartInstances[n].destroy();
        window._chartInstances[n] = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label: `累積 (${cohort})`, data: cum, borderColor: '#1976d2', backgroundColor: '#1976d222', fill: true, tension: 0.2 }] },
          options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { display: true }, y: { beginAtZero: true } } }
        });
        debugEl.textContent = '';
      } catch (err) {
        debugEl.textContent = '錯誤: ' + (err.message || String(err));
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      for(let n=1;n<=3;n++){
        const sel = document.getElementById('cohort'+n);
        if(sel) sel.addEventListener('change', ()=>loadSheetChart(n));
        loadSheetChart(n);
      }

      (async function fetchDialogues(){
        const target = document.getElementById('dialogues-list');
        try {
          const res = await fetch('/api/dialogue');
          if(!res.ok) throw new Error('dialogue fetch ' + res.status);
          const j = await res.json();
          const rows = Array.isArray(j.rows) ? j.rows : [];
          if(!rows.length){ target.textContent = '沒有對話紀錄。'; return; }
          target.innerHTML = rows.reverse().map(r => `<div class="dialogue"><b>${r.role || ''}</b> <span style="color:#888">${r.created_at || ''}</span><div>${escapeHtml(r.message || '')}</div></div>`).join('');
        } catch(err) { target.textContent = '無法載入對話'; }
      })();
    });

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  })();
  </script>
</body>
</html>